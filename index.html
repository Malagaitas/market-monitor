<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GPT - Great Portfolio Tracer</title>
  <meta name="theme-color" content="#0f62fe"/>
  <link rel="icon" type="image/svg+xml" href="logo.svg"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png"/>
  <style>
    :root { --brand:#0f62fe; --bg:#f5f7fb; --card:#ffffff; --text:#0b1221; --muted:#66758f; --border:#e5e8ef; --sidebar:#eef2ff; --star:#ffb400; }
    [data-theme="dark"] { --bg:#0b0f17; --card:#111827; --text:#f5f7fb; --muted:#b6c0d1; --border:#24324a; --sidebar:#0f172a; --star:#ffd166; }
    * { box-sizing:border-box; } body { margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    header { padding:10px 16px; background:var(--brand); color:#fff; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .brand { display:flex; gap:10px; align-items:center; } .brand img { height:26px }
    .header-actions { display:flex; align-items:center; gap:8px; }
    .toggle-btn { background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.3); color:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:600; }
    .icon-round { width:36px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.3); background:rgba(255,255,255,.1); cursor:pointer; position:relative; }
    .badge { position:absolute; top:-6px; right:-6px; background:#ef4444; color:white; font-size:11px; font-weight:800; padding:2px 6px; border-radius:999px; }
    main { max-width:1500px; margin:0 auto; padding:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; }
    /* Toolbars */
    .toolbar { display:flex; gap:10px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card); margin-top:12px; }
    .toolbar .search { flex:0 0 220px; }
    .toolbar input[type="text"] { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text); }
    .tabs { display:flex; gap:6px; flex-wrap:wrap; }
    .tab { padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:var(--card); color:var(--text); cursor:pointer; font-weight:600; }
    .tab.active { background:var(--brand); border-color:var(--brand); color:#fff; }
    .muted { color:var(--muted); font-size:12px; }
    /* Layout */
    .layout { display:grid; grid-template-columns:360px 1fr; gap:16px; align-items:start; margin-top:16px; }
    .layout.list-collapsed { grid-template-columns:1fr; }
    .list { border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .list-header { display:flex; align-items:center; gap:8px; padding:10px; border-bottom:1px solid var(--border); justify-content:space-between; }
    .icon-btn { appearance:none; border:1px solid var(--border); background:var(--card); color:var(--text); width:36px; height:36px; border-radius:8px; cursor:pointer; font-weight:800; line-height:1; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid var(--border); cursor:pointer; }
    .row:hover { background: rgba(15, 98, 254, .08); }
    .left { display:flex; flex-direction:column; gap:3px; }
    .symbol { font-weight:700; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid var(--border); background:var(--card); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; color:var(--text); }
    .btn.active { background: var(--brand); border-color: var(--brand); color:white; }
    .star { font-size:18px; margin-left:8px; user-select:none; }
    .bell { font-size:18px; margin-left:8px; user-select:none; }
    .plus { font-size:20px; user-select:none; }
    .floating-btn { position: fixed; top: 50%; transform: translateY(-50%); z-index: 50; width:40px; height:40px; border-radius: 999px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-weight: 900; box-shadow: 0 1px 2px rgba(0,0,0,.12); right:8px; display:none; }
    @media (max-width: 1080px) { .layout { grid-template-columns:1fr; } .toolbar { flex-wrap:wrap; } }
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="logo.svg" alt="GPT logo"/><strong>GPT - Great Portfolio Tracer</strong></div>
    <div class="header-actions">
      <div id="alertsBtn" class="icon-round" title="Alerts">ðŸ””<span id="alertsBadge" class="badge" style="display:none;">0</span></div>
      <div id="helpBtn" class="icon-round" title="Help">â“˜</div>
      <div id="settingsBtn" class="icon-round" title="Settings">âš™</div>
      <button id="themeToggle" class="toggle-btn" title="Toggle light/dark"><span id="themeIcon">â˜€</span><span id="themeLabel">Light</span></button>
      <div id="helpPopover" class="card" style="position:absolute; right:16px; top:52px; display:none; width:360px;">
        <h4 style="margin:6px 0 10px;">Quick tips</h4>
        <ul style="margin:0 0 6px 18px;">
          <li>Use <b>â˜°</b> to hide/show the left list.</li>
          <li>Search finds symbols across all categories.</li>
          <li>Click a symbol to load it; <b>â˜…</b> for favorites.</li>
          <li><b>ï¼‹</b> adds to your custom watchlists (My Lists).</li>
          <li><b>ðŸ””</b> sets a local price alert.</li>
        </ul>
      </div>
      <div id="alertsPopover" class="card" style="position:absolute; right:16px; top:52px; display:none; width:380px; max-height:420px; overflow:auto;">
        <h4 style="margin:6px 0 10px;">Active alerts</h4>
        <div id="alertsList"></div>
        <div id="clearAlerts" class="muted" style="margin-top:8px; cursor:pointer;">Clear all</div>
      </div>
    </div>
  </header>

  <main>
    <!-- Ticker -->
    <div class="card" style="margin-top:16px">
      <div id="ticker-host"><div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div></div>
    </div>

    <!-- Toolbar 1: Asset + Search -->
    <div class="toolbar" id="assetToolbar">
      <div class="search"><input id="searchTop" type="text" placeholder="Search symbols (e.g., SOLUSDT, VT, EURCHF)"/></div>
      <div class="muted">Asset:</div>
      <div id="assetTabs" class="tabs"></div>
    </div>

    <!-- Toolbar 2: Group (+ New list when applicable) -->
    <div class="toolbar" id="groupToolbar">
      <div class="muted">Group:</div>
      <div id="groupTabs" class="tabs"></div>
      <div id="newListWrap" style="display:none; margin-left:auto;"><button id="newListBtn" class="btn">+ New list</button></div>
    </div>

    <div id="gridLayout" class="layout">
      <!-- List (left) -->
      <section class="list">
        <div class="list-header">
          <div class="controls"><strong id="listTitle">Symbols</strong><span class="muted" id="countPill" style="margin-left:8px;">0</span></div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="listToggle" class="icon-btn" title="Hide list">â˜°</button>
          </div>
        </div>
        <div id="symbolList"></div>
      </section>

      <!-- Chart (right) -->
      <section class="card">
        <div class="controls" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div class="controls">
            <strong>Interval:</strong>
            <button class="btn" data-int="D">1D</button>
            <button class="btn" data-int="W">1W</button>
            <button class="btn" data-int="60">1H</button>
          </div>
          <div class="controls">
            <strong>Range:</strong>
            <button class="btn" data-range="1D">1D</button>
            <button class="btn" data-range="1M">1M</button>
            <button class="btn" data-range="3M">3M</button>
            <button class="btn" data-range="YTD">YTD</button>
            <button class="btn" data-range="12M">1Y</button>
            <button class="btn" data-range="60M">5Y</button>
            <button class="btn" data-range="120M">10Y</button>
            <button class="btn" data-range="ALL">ALL</button>
          </div>
        </div>
        <div id="adv-host" style="height:620px;"></div>
        <p class="muted">Click a symbol to load the chart. Use â˜… favorites, ï¼‹ add to list, ðŸ”” set alert.</p>
      </section>
    </div>

    <button id="listShowFloating" class="floating-btn" title="Show list">â˜°</button>
  </main>

  <footer style="text-align:center; color:#66758f; padding:16px; border-top:1px solid var(--border); margin-top:24px;">GPT - Great Portfolio Tracer</footer>

<script>
  // ====== Config & state ======
  const TICKER_CFG = { light: {
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "AMEX:SPY",
      "title": "SPY"
    },
    {
      "proName": "NASDAQ:QQQ",
      "title": "QQQ"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "light",
  "locale": "en"
}, dark: {
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "AMEX:SPY",
      "title": "SPY"
    },
    {
      "proName": "NASDAQ:QQQ",
      "title": "QQQ"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "dark",
  "locale": "en"
} };
  const CATALOG_BASE = {"favorites": {"label": "\u2605 Favorites", "groups": {"my_favs": {"label": "My Favorites", "symbols": []}}}, "mylists": {"label": "My Lists", "groups": {}}, "equities": {"label": "Stocks", "groups": {"us_top": {"label": "US Top", "symbols": [{"s": "NASDAQ:NVDA", "d": "NVDA \u2014 NVIDIA"}, {"s": "NASDAQ:MSFT", "d": "MSFT \u2014 Microsoft"}, {"s": "NASDAQ:AAPL", "d": "AAPL \u2014 Apple"}, {"s": "NASDAQ:AMZN", "d": "AMZN \u2014 Amazon"}, {"s": "NASDAQ:META", "d": "META \u2014 Meta"}, {"s": "NASDAQ:AVGO", "d": "AVGO \u2014 Broadcom"}, {"s": "NASDAQ:GOOGL", "d": "GOOGL \u2014 Alphabet A"}, {"s": "NYSE:BRK.B", "d": "BRK.B \u2014 Berkshire B"}, {"s": "NASDAQ:TSLA", "d": "TSLA \u2014 Tesla"}, {"s": "NYSE:LLY", "d": "LLY \u2014 Eli Lilly"}]}, "us_nyse": {"label": "NYSE (US)", "symbols": [{"s": "NYSE:KO", "d": "KO \u2014 Coca\u2011Cola"}, {"s": "NYSE:JPM", "d": "JPM \u2014 JPMorgan"}, {"s": "NYSE:BRK.B", "d": "BRK.B \u2014 Berkshire B"}]}, "us_nasdaq": {"label": "NASDAQ (US)", "symbols": [{"s": "NASDAQ:AAPL", "d": "AAPL \u2014 Apple"}, {"s": "NASDAQ:MSFT", "d": "MSFT \u2014 Microsoft"}, {"s": "NASDAQ:NVDA", "d": "NVDA \u2014 NVIDIA"}]}, "uk_lse": {"label": "London (LSE)", "symbols": [{"s": "LSE:VOD", "d": "VOD \u2014 Vodafone"}, {"s": "LSE:ULVR", "d": "ULVR \u2014 Unilever"}, {"s": "LSE:HSBA", "d": "HSBA \u2014 HSBC"}]}, "ch_six": {"label": "Switzerland (SIX)", "symbols": [{"s": "SIX:NESN", "d": "NESN \u2014 Nestl\u00e9"}, {"s": "SIX:NOVN", "d": "NOVN \u2014 Novartis"}, {"s": "SIX:ROG", "d": "ROG \u2014 Roche Holding"}]}, "jp_tse": {"label": "Tokyo (TSE)", "symbols": [{"s": "TSE:7203", "d": "7203 \u2014 Toyota"}, {"s": "TSE:6758", "d": "6758 \u2014 Sony Group"}, {"s": "TSE:9984", "d": "9984 \u2014 SoftBank Group"}]}, "hk_hkex": {"label": "Hong Kong (HKEX)", "symbols": [{"s": "HKEX:700", "d": "700 \u2014 Tencent"}, {"s": "HKEX:9988", "d": "9988 \u2014 Alibaba Group"}]}}}, "crypto": {"label": "Crypto", "groups": {"top_volume": {"label": "Top by Volume (Binance)", "symbols": [{"s": "BINANCE:BTCUSDT", "d": "BTCUSDT \u2014 Bitcoin"}, {"s": "BINANCE:ETHUSDT", "d": "ETHUSDT \u2014 Ethereum"}, {"s": "BINANCE:SOLUSDT", "d": "SOLUSDT \u2014 Solana"}, {"s": "BINANCE:BNBUSDT", "d": "BNBUSDT \u2014 BNB"}, {"s": "BINANCE:XRPUSDT", "d": "XRPUSDT \u2014 XRP"}, {"s": "BINANCE:DOGEUSDT", "d": "DOGEUSDT \u2014 Dogecoin"}, {"s": "BINANCE:TONUSDT", "d": "TONUSDT \u2014 Toncoin"}, {"s": "BINANCE:ADAUSDT", "d": "ADAUSDT \u2014 Cardano"}, {"s": "BINANCE:TRXUSDT", "d": "TRXUSDT \u2014 TRON"}, {"s": "BINANCE:AVAXUSDT", "d": "AVAXUSDT \u2014 Avalanche"}, {"s": "BINANCE:LINKUSDT", "d": "LINKUSDT \u2014 Chainlink"}, {"s": "BINANCE:LTCUSDT", "d": "LTCUSDT \u2014 Litecoin"}, {"s": "BINANCE:SHIBUSDT", "d": "SHIBUSDT \u2014 Shiba Inu"}, {"s": "BINANCE:NEARUSDT", "d": "NEARUSDT \u2014 NEAR"}]}}}, "etfs": {"label": "ETFs", "groups": {"core_us": {"label": "Core US", "symbols": [{"s": "AMEX:SPY", "d": "SPY \u2014 SPDR S&P 500"}, {"s": "AMEX:VOO", "d": "VOO \u2014 Vanguard S&P 500"}, {"s": "NASDAQ:QQQ", "d": "QQQ \u2014 Invesco QQQ"}, {"s": "AMEX:VTI", "d": "VTI \u2014 Vanguard Total Market"}, {"s": "AMEX:VT", "d": "VT \u2014 Vanguard Total World Stock"}]}, "top_volume_us": {"label": "Top by Volume (US)", "symbols": [{"s": "AMEX:IVV", "d": "IVV \u2014 iShares Core S&P 500"}, {"s": "AMEX:IWM", "d": "IWM \u2014 iShares Russell 2000"}, {"s": "AMEX:EEM", "d": "EEM \u2014 iShares MSCI Emerging Markets"}, {"s": "AMEX:EFA", "d": "EFA \u2014 iShares MSCI EAFE"}, {"s": "AMEX:HYG", "d": "HYG \u2014 iShares High Yield Corp Bond"}, {"s": "AMEX:LQD", "d": "LQD \u2014 iShares iBoxx $ IG Corp Bond"}, {"s": "AMEX:TLT", "d": "TLT \u2014 iShares 20+ Year Treasury"}, {"s": "AMEX:GLD", "d": "GLD \u2014 SPDR Gold Trust"}, {"s": "AMEX:XLF", "d": "XLF \u2014 Financial Select Sector SPDR"}, {"s": "AMEX:XLE", "d": "XLE \u2014 Energy Select Sector SPDR"}]}, "ucits_eu": {"label": "UCITS (EU/UK)", "symbols": [{"s": "XETR:EUNL", "d": "EUNL \u2014 iShares Core MSCI World UCITS"}, {"s": "XETR:SXR8", "d": "SXR8 \u2014 iShares Core S&P 500 UCITS (Acc)"}, {"s": "LSE:VWRL", "d": "VWRL \u2014 Vanguard FTSE All-World UCITS"}]}}}, "fx": {"label": "FX", "groups": {"majors_chf": {"label": "Majors & CHF", "symbols": [{"s": "OANDA:EURUSD", "d": "EURUSD \u2014 Euro / US Dollar"}, {"s": "OANDA:USDCHF", "d": "USDCHF \u2014 US Dollar / Swiss Franc"}, {"s": "OANDA:EURCHF", "d": "EURCHF \u2014 Euro / Swiss Franc"}]}}}, "commodities": {"label": "Commodities", "groups": {"energy": {"label": "Energy", "symbols": [{"s": "NYMEX:CL1!", "d": "CL1! \u2014 Crude Oil WTI"}, {"s": "NYMEX:NG1!", "d": "NG1! \u2014 Natural Gas"}]}, "precious": {"label": "Precious Metals", "symbols": [{"s": "COMEX:GC1!", "d": "GC1! \u2014 Gold Futures"}, {"s": "COMEX:SI1!", "d": "SI1! \u2014 Silver Futures"}]}}}};

  function safeJSON(s) { try { return JSON.parse(s||''); } catch(e) { return null; } }

  const store = {
    theme: localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'),
    listCollapsed: localStorage.getItem('listCollapsed')==='true',
    favorites: safeJSON(localStorage.getItem('favorites')) || [],
    mylists: safeJSON(localStorage.getItem('mylists')) || {},
    lastSymbol: localStorage.getItem('lastSymbol') || null,
    interval: localStorage.getItem('interval') || 'D',
    range: localStorage.getItem('range') || '12M',
    asset: localStorage.getItem('asset') || 'equities',
    group: localStorage.getItem('group') || 'us_nyse',
    alerts: safeJSON(localStorage.getItem('alerts')) || [],
    alphaKey: localStorage.getItem('alphaKey') || '',
    pollSec: parseInt(localStorage.getItem('pollSec') || '30', 10),
  };

  function buildCatalog() {
    const C = JSON.parse(JSON.stringify(CATALOG_BASE));
    const dyn = {};
    Object.entries(store.mylists).forEach(([id,obj]) => dyn[id] = { label: obj.label, symbols: obj.symbols||[] });
    C.mylists.groups = dyn;
    return C;
  }
  let CATALOG = buildCatalog();

  // ====== Theme & header popovers ======
  document.documentElement.setAttribute('data-theme', store.theme);
  const themeBtn = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeLabel = document.getElementById('themeLabel');
  function updateTheme() { themeLabel.textContent = store.theme==='dark'?'Dark':'Light'; themeIcon.textContent = store.theme==='dark'?'ðŸŒ™':'â˜€'; }
  updateTheme();
  themeBtn.addEventListener('click', ()=>{ store.theme = store.theme==='light'?'dark':'light'; localStorage.setItem('theme', store.theme); document.documentElement.setAttribute('data-theme', store.theme); updateTheme(); renderTicker(); renderAdvanced(); });

  function togglePopover(btnId, popId){ const btn=document.getElementById(btnId), pop=document.getElementById(popId); let open=false; btn.addEventListener('click',(e)=>{ e.stopPropagation(); open=!open; pop.style.display=open?'block':'none'; if(popId==='alertsPopover') renderAlertsList(); }); document.addEventListener('click',(e)=>{ if(open && !pop.contains(e.target) && e.target!==btn){ open=false; pop.style.display='none'; } }); }
  togglePopover('helpBtn','helpPopover'); togglePopover('alertsBtn','alertsPopover');

  // ====== Ticker ======
  function renderTicker() {
    const host = document.getElementById('ticker-host');
    host.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
    script.async = true;
    script.innerHTML = JSON.stringify(TICKER_CFG[store.theme], null, 2);
    host.querySelector('.tradingview-widget-container').appendChild(script);
  }
  renderTicker();

  // ====== Dual toolbars (asset tabs + group tabs) ======
  const assetTabs = document.getElementById('assetTabs');
  const groupTabs = document.getElementById('groupTabs');
  const newListWrap = document.getElementById('newListWrap');
  const newListBtn  = document.getElementById('newListBtn');
  const searchTop   = document.getElementById('searchTop');

  function renderAssetTabs(){
    assetTabs.innerHTML='';
    Object.entries(CATALOG).forEach(([id, meta])=>{
      const b=document.createElement('button'); b.className='tab'+(id===store.asset?' active':''); b.textContent=meta.label;
      b.addEventListener('click', ()=>{ store.asset=id; localStorage.setItem('asset', id);
        const gs = CATALOG[id].groups; const first = Object.keys(gs)[0];
        if(!gs[store.group]) store.group = first; localStorage.setItem('group', store.group);
        renderAssetTabs(); renderGroupTabs(); renderList();
      });
      assetTabs.appendChild(b);
    });
  }

  function renderGroupTabs(){
    groupTabs.innerHTML='';
    const gs = CATALOG[store.asset]?.groups || {};
    Object.entries(gs).forEach(([gid, g])=>{
      const b=document.createElement('button'); b.className='tab'+(gid===store.group?' active':''); b.textContent=g.label;
      b.addEventListener('click', ()=>{ store.group=gid; localStorage.setItem('group', gid); renderGroupTabs(); renderList(); });
      groupTabs.appendChild(b);
    });
    newListWrap.style.display = store.asset==='mylists' ? 'block' : 'none';
  }

  newListBtn.addEventListener('click', ()=>{
    const name = prompt('New list name:'); if(!name) return;
    const id = Math.random().toString(36).slice(2,9);
    store.mylists[id] = { label: name, symbols: [] };
    localStorage.setItem('mylists', JSON.stringify(store.mylists));
    CATALOG = buildCatalog();
    store.asset='mylists'; store.group=id; localStorage.setItem('asset','mylists'); localStorage.setItem('group', id);
    renderAssetTabs(); renderGroupTabs(); renderList();
  });

  renderAssetTabs(); renderGroupTabs();

  // ====== Layout (list collapse) ======
  const gridLayout = document.getElementById('gridLayout');
  const listToggle = document.getElementById('listToggle');
  const listShowFloating = document.getElementById('listShowFloating');
  function applyLayout(){
    gridLayout.classList.toggle('list-collapsed', store.listCollapsed);
    listShowFloating.style.display = store.listCollapsed ? 'block' : 'none';
    listToggle.title = store.listCollapsed ? 'Show list' : 'Hide list';
  }
  applyLayout();
  listToggle.addEventListener('click', ()=>{ store.listCollapsed=!store.listCollapsed; localStorage.setItem('listCollapsed', store.listCollapsed); applyLayout(); setTimeout(renderAdvanced,60); });
  listShowFloating.addEventListener('click', ()=>{ store.listCollapsed=false; localStorage.setItem('listCollapsed', 'false'); applyLayout(); setTimeout(renderAdvanced,60); });

  // ====== List + search ======
  const listTitle=document.getElementById('listTitle'); const countPill=document.getElementById('countPill'); const listHost=document.getElementById('symbolList');
  function getAllSymbols(){ const arr=[]; Object.values(CATALOG).forEach(asset=>{ Object.values(asset.groups).forEach(g=> g.symbols.forEach(x=>arr.push({s:x.s,d:x.d}))); }); const seen=new Set(); return arr.filter(x=> seen.has(x.s)?false:(seen.add(x.s),true)); }
  let ALL_SYMBOLS = getAllSymbols();
  function refreshAll(){ ALL_SYMBOLS = getAllSymbols(); }

  function getGroupSymbols(){ if(store.asset==='favorites') return store.favorites; if(store.asset==='mylists') return (store.mylists[store.group]?.symbols)||[]; return CATALOG[store.asset].groups[store.group].symbols; }
  function getGlobalResults(q){ const qq=q.toLowerCase(); return ALL_SYMBOLS.filter(x=>x.s.toLowerCase().includes(qq)||(x.d||'').toLowerCase().includes(qq)); }
  function isFav(sym){ return store.favorites.some(x=>x.s===sym); }
  function saveFavs(){ localStorage.setItem('favorites', JSON.stringify(store.favorites)); }

  function addToMyList(obj){
    const keys=Object.keys(store.mylists); let target=keys[0];
    if(keys.length===0){ const name=prompt('Create a new list name:'); if(!name) return; const id=Math.random().toString(36).slice(2,9); store.mylists[id]={label:name, symbols:[]}; target=id; }
    else { const names=keys.map(k=>store.mylists[k].label); const choice=prompt('Add to which list?\n'+names.map((n,i) => (i+1)+'. '+n).join('\n'),'1'); if(!choice) return; const idx=parseInt(choice,10)-1; if(isNaN(idx)||idx<0||idx>=keys.length) return; target=keys[idx]; }
    const arr=store.mylists[target].symbols; if(!arr.some(x=>x.s===obj.s)) arr.push(obj);
    localStorage.setItem('mylists', JSON.stringify(store.mylists));
    CATALOG = buildCatalog(); refreshAll();
    renderGroupTabs(); renderList();
  }

  function renderList(){
    const q=(searchTop.value||'').trim(); let symbols, title;
    if(q){ symbols=getGlobalResults(q); title='Search results'; }
    else if(store.asset==='favorites'){ symbols=getGroupSymbols(); title='My Favorites'; }
    else if(store.asset==='mylists'){ symbols=getGroupSymbols(); title=store.mylists[store.group]?.label || 'My Lists'; }
    else { const meta=CATALOG[store.asset].groups[store.group]; symbols=meta.symbols; title=meta.label; }
    listTitle.textContent=title; countPill.textContent=symbols.length+' items'; listHost.innerHTML='';
    symbols.forEach(obj=>{
      const row=document.createElement('div'); row.className='row';
      const left=document.createElement('div'); left.className='left';
      const sym=document.createElement('div'); sym.className='symbol'; sym.textContent=obj.s;
      const desc=document.createElement('div'); desc.className='muted'; desc.textContent=obj.d||'';
      left.appendChild(sym); left.appendChild(desc);
      const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
      const plus=document.createElement('span'); plus.className='plus'; plus.textContent='ï¼‹'; plus.title='Add to My Lists'; plus.addEventListener('click',(e)=>{ e.stopPropagation(); addToMyList(obj); });
      const bell=document.createElement('span'); bell.className='bell'; bell.textContent='ðŸ””'; bell.title='Set alert'; bell.addEventListener('click',(e)=>{ e.stopPropagation(); createAlertFlow(obj); });
      const star=document.createElement('span'); star.className='star'+(isFav(obj.s)?' fav':''); star.textContent=isFav(obj.s)?'â˜…':'â˜†'; star.title=isFav(obj.s)?'Remove favorite':'Add favorite';
      star.addEventListener('click',(e)=>{ e.stopPropagation(); if(isFav(obj.s)) store.favorites=store.favorites.filter(x=>x.s!==obj.s); else store.favorites.push(obj); saveFavs(); star.classList.toggle('fav'); star.textContent=star.classList.contains('fav')?'â˜…':'â˜†'; });
      const arrow=document.createElement('div'); arrow.className='muted'; arrow.style.marginLeft='8px'; arrow.textContent='âžœ';
      right.appendChild(plus); right.appendChild(bell); right.appendChild(star); right.appendChild(arrow);
      row.appendChild(left); row.appendChild(right);
      row.addEventListener('click',()=>{ store.lastSymbol=obj.s; localStorage.setItem('lastSymbol', store.lastSymbol); renderAdvanced(); });
      listHost.appendChild(row);
    });
  }
  searchTop.addEventListener('input', ()=>renderList());
  renderList();

  // ====== Advanced chart ======
  const advHost = document.getElementById('adv-host');
  const intButtons = Array.from(document.querySelectorAll('.btn[data-int]'));
  const rangeButtons = Array.from(document.querySelectorAll('.btn[data-range]'));
  function syncBtns(){ intButtons.forEach(b=>b.classList.toggle('active', b.dataset.int===store.interval)); rangeButtons.forEach(b=>b.classList.toggle('active', b.dataset.range===store.range)); }
  function renderAdvanced(){
    syncBtns();
    advHost.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
    script.async = true;
    const cfg = {
      autosize: true, symbol: store.lastSymbol || 'BINANCE:BTCUSDT',
      interval: store.interval, range: store.range, timezone: 'Etc/UTC',
      theme: store.theme, style: '1', locale: 'en',
      allow_symbol_change: false, withdateranges: true,
      hide_side_toolbar: false, hide_top_toolbar: false, save_image: false,
      studies: [], calendar: false, support_host: 'https://www.tradingview.com'
    };
    script.innerHTML = JSON.stringify(cfg, null, 2);
    advHost.querySelector('.tradingview-widget-container').appendChild(script);
  }
  intButtons.forEach(btn=>btn.addEventListener('click',()=>{ store.interval=btn.dataset.int; localStorage.setItem('interval', store.interval); renderAdvanced(); }));
  rangeButtons.forEach(btn=>btn.addEventListener('click',()=>{ store.range=btn.dataset.range; localStorage.setItem('range', store.range); renderAdvanced(); }));
  renderAdvanced();

  // ====== Settings modal placeholders (non-UI) ======
  const settingsBtn=document.getElementById('settingsBtn'); const backdrop=document.getElementById('backdrop'); const settingsModal=document.getElementById('settingsModal');
  const alphaKeyInput=document.getElementById('alphaKey'); const pollSecInput=document.getElementById('pollSec'); const settingsSave=document.getElementById('settingsSave'); const settingsCancel=document.getElementById('settingsCancel');
  function openModal(){ /* optional modal implementation */ }
  function closeModal(){ /* optional */ }
  settingsBtn.addEventListener('click', ()=>alert('Settings: add Alpha Vantage API key and polling interval in a future version.'));

  // ====== Alerts ======
  const alertsBadge=document.getElementById('alertsBadge'); const alertsList=document.getElementById('alertsList'); const clearAlerts=document.getElementById('clearAlerts');
  function updateAlertsBadge(){ const n=store.alerts.length; alertsBadge.style.display=n>0?'inline-block':'none'; alertsBadge.textContent=n; }
  function persistAlerts(){ localStorage.setItem('alerts', JSON.stringify(store.alerts)); updateAlertsBadge(); }
  updateAlertsBadge();
  if(clearAlerts){ clearAlerts.addEventListener('click', ()=>{ if(confirm('Clear all alerts?')) { store.alerts=[]; persistAlerts(); renderAlertsList(); } }); }
  function renderAlertsList(){
    if(!alertsList) return;
    alertsList.innerHTML='';
    if(store.alerts.length===0){ alertsList.innerHTML='<div class="muted">No active alerts</div>'; return; }
    store.alerts.forEach((a,idx)=>{
      const line=document.createElement('div'); line.className='row'; line.style.padding='6px 0'; line.style.cursor='default';
      const left=document.createElement('div'); left.textContent = a.s + ' ' + (a.dir==='above'?'â‰¥':'â‰¤') + ' ' + a.target + (a.source==='binance'?' (Binance)':(a.source==='alpha'?' (Alpha)':' (N/A)'));
      const rm=document.createElement('span'); rm.className='muted'; rm.style.cursor='pointer'; rm.textContent='remove';
      rm.addEventListener('click',()=>{ store.alerts.splice(idx,1); persistAlerts(); renderAlertsList(); });
      line.appendChild(left); line.appendChild(rm); alertsList.appendChild(line);
    });
  }

  function mapSymbol(sym){
    const p=sym.split(':'), ex=p[0], code=p.slice(1).join(':');
    if(ex==='BINANCE') return { source:'binance', url:'https://api.binance.com/api/v3/ticker/price?symbol='+code, parse:(j)=>parseFloat(j.price) };
    if(ex==='OANDA' && code.length===6 && store.alphaKey){
      const from=code.slice(0,3), to=code.slice(3);
      return { source:'alpha', url:'https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency='+from+'&to_currency='+to+'&apikey='+store.alphaKey, parse:(j)=>parseFloat(j['Realtime Currency Exchange Rate']&&j['Realtime Currency Exchange Rate']['5. Exchange Rate']) };
    }
    let ticker=code; if(ex==='SIX') ticker=code+'.SW';
    if(store.alphaKey) return { source:'alpha', url:'https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol='+encodeURIComponent(ticker)+'&apikey='+store.alphaKey, parse:(j)=>parseFloat(j['Global Quote']&&j['Global Quote']['05. price']) };
    return { source:null };
  }

  function createAlertFlow(obj){
    const when = prompt('Alert when price is (above | below):','above'); if(!when) return;
    const t = parseFloat(prompt('Target price:','')); if(!isFinite(t)) return;
    const map = mapSymbol(obj.s); if(!map.source) alert('This symbol may not be supported for live polling unless you add an API key in Settings.');
    const a={ id:Math.random().toString(36).slice(2,9), s:obj.s, d:obj.d||'', target:t, dir:(when.toLowerCase()==='below'?'below':'above'), source:map.source, map:map, createdAt:Date.now() };
    store.alerts.push(a); persistAlerts(); renderAlertsList(); if('Notification' in window && Notification.permission==='default') Notification.requestPermission(); alert('Alert added for '+obj.s);
  }

  async function pollAlerts(){
    if(store.alerts.length===0) return;
    for(const a of [...store.alerts]){
      try{
        if(a.source==='binance'){
          const r=await fetch(a.map.url); if(!r.ok) continue; const j=await r.json(); const price=a.map.parse(j); if(!isFinite(price)) continue;
          if((a.dir==='above' && price>=a.target) || (a.dir==='below' && price<=a.target)){ alert('Alert: '+a.s+' hit '+a.dir+' '+a.target+' (now '+price+')'); store.alerts=store.alerts.filter(x=>x.id!==a.id); persistAlerts(); renderAlertsList(); }
        } else if(a.source==='alpha' && store.alphaKey){
          const r=await fetch(a.map.url); if(!r.ok) continue; const j=await r.json(); const price=a.map.parse(j); if(!isFinite(price)) continue;
          if((a.dir==='above' && price>=a.target) || (a.dir==='below' && price<=a.target)){ alert('Alert: '+a.s+' hit '+a.dir+' '+a.target+' (now '+price+')'); store.alerts=store.alerts.filter(x=>x.id!==a.id); persistAlerts(); renderAlertsList(); }
        }
      }catch(e){}
    }
  }
  setInterval(pollAlerts, Math.max(10, store.pollSec)*1000);
</script>
<script>
  // Advanced chart loader (theme-aware ticker init)
  (function(){
    const host=document.getElementById('ticker-host');
    const theme=(localStorage.getItem('theme')||'light');
    const cfg=theme==='dark'?{
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "AMEX:SPY",
      "title": "SPY"
    },
    {
      "proName": "NASDAQ:QQQ",
      "title": "QQQ"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "dark",
  "locale": "en"
}:{
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "AMEX:SPY",
      "title": "SPY"
    },
    {
      "proName": "NASDAQ:QQQ",
      "title": "QQQ"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "light",
  "locale": "en"
};
    host.innerHTML='<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
    const s=document.createElement('script'); s.src='https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js'; s.async=true; s.innerHTML=JSON.stringify(cfg, null, 2); host.querySelector('.tradingview-widget-container').appendChild(s);
  })();
</script>
</body>
</html>
