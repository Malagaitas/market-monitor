<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GPT - Great Portfolio Tracer</title>
  <meta name="theme-color" content="#0f62fe"/>
  <link rel="icon" type="image/svg+xml" href="logo.svg"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png"/>
  <style>
    :root { --brand:#0f62fe; --bg:#f5f7fb; --card:#ffffff; --text:#0b1221; --muted:#66758f; --border:#e5e7ef; --sidebar:#eef2ff; --star:#ffb400; }
    [data-theme="dark"] { --bg:#0b0f17; --card:#111827; --text:#f5f7fb; --muted:#b6c0d1; --border:#24324a; --sidebar:#0f172a; --star:#ffd166; }
    * { box-sizing:border-box; } body { margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    header { padding:10px 16px; background:var(--brand); color:#fff; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .brand { display:flex; gap:10px; align-items:center; } .brand img { height:26px }
    .header-actions { display:flex; align-items:center; gap:8px; }
    .toggle-btn { background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.3); color:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:600; }
    .icon-round { width:36px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.3); background:rgba(255,255,255,.1); cursor:pointer; position:relative; }
    .badge { position:absolute; top:-6px; right:-6px; background:#ef4444; color:white; font-size:11px; font-weight:800; padding:2px 6px; border-radius:999px; }
    main { max-width:1500px; margin:0 auto; padding:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; }
    /* Toolbar */
    .toolbar { display:flex; gap:12px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card); margin-top:12px; flex-wrap:wrap; }
    .toolbar .search { flex:0 0 200px; }
    .toolbar input[type="text"] { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text); }
    .toolbar .tabs-wrap { display:flex; flex-direction:column; gap:6px; flex:1 1 auto; min-width:280px; }
    .tabs { display:flex; gap:6px; flex-wrap:wrap; }
    .tab { padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:var(--card); cursor:pointer; font-weight:600; }
    .tab.active { background:var(--brand); border-color:var(--brand); color:white; }
    .tabs-sub .tab { padding:6px 10px; font-weight:600; opacity:.95; }
    .toolbar .btn { padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); cursor:pointer; }
    /* Layout: list + chart */
    .layout { display:grid; grid-template-columns:360px 1fr; gap:16px; align-items:start; margin-top:16px; }
    .layout.list-collapsed { grid-template-columns:1fr; }
    .list { border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .list-header { display:flex; align-items:center; gap:8px; padding:10px; border-bottom:1px solid var(--border); justify-content:space-between; }
    .icon-btn { appearance:none; border:1px solid var(--border); background:var(--card); color:var(--text); width:36px; height:36px; border-radius:8px; cursor:pointer; font-weight:800; line-height:1; display:none; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid var(--border); cursor:pointer; }
    .row:hover { background: rgba(15, 98, 254, .08); }
    .left { display:flex; flex-direction:column; gap:3px; }
    .symbol { font-weight:700; }
    .muted { color:var(--muted); font-size:12px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid var(--border); background:var(--card); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; color:var(--text); }
    .btn.active { background: var(--brand); border-color: var(--brand); color:white; }
    .star { font-size:18px; margin-left:8px; user-select:none; }
    .bell { font-size:18px; margin-left:8px; user-select:none; }
    .plus { font-size:20px; margin-left:8px; user-select:none; }
    .floating-btn { position: fixed; top: 50%; transform: translateY(-50%); z-index: 50; width:40px; height:40px; border-radius: 999px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-weight: 900; box-shadow: 0 1px 2px rgba(0,0,0,.12); right:10px; display:block; }
    @media (max-width: 1080px) { .layout { grid-template-columns:1fr; } .toolbar .search { flex:1 1 100%; order:-1; } }
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="logo.svg" alt="GPT logo"/><strong>GPT - Great Portfolio Tracer</strong></div>
    <div class="header-actions">
      <div id="alertsBtn" class="icon-round" title="Alerts">ðŸ””<span id="alertsBadge" class="badge" style="display:none;">0</span></div>
      <div id="helpBtn" class="icon-round" title="Help">â“˜</div>
      <div id="settingsBtn" class="icon-round" title="Settings">âš™</div>
      <button id="themeToggle" class="toggle-btn" title="Toggle light/dark"><span id="themeIcon">â˜€</span><span id="themeLabel">Light</span></button>
      <div id="helpPopover" class="card" style="position:absolute; right:16px; top:52px; display:none; width:360px;">
        <h4 style="margin:6px 0 10px;">Quick tips</h4>
        <ul style="margin:0 0 6px 18px;">
          <li>Use <b>â˜°</b> (right side) to hide/show the left list.</li>
          <li>Tabs: first row = Asset class; second row = Group.</li>
          <li>Search (left) finds symbols across all categories.</li>
          <li><b>ï¼‹</b> adds to your custom watchlists; <b>ðŸ””</b> sets alerts.</li>
        </ul>
      </div>
      <div id="alertsPopover" class="card" style="position:absolute; right:16px; top:52px; display:none; width:380px; max-height:420px; overflow:auto;">
        <h4 style="margin:6px 0 10px;">Active alerts</h4>
        <div id="alertsList"></div>
        <div id="clearAlerts" class="muted" style="margin-top:8px; cursor:pointer;">Clear all</div>
      </div>
    </div>
  </header>

  <main>
    <!-- Ticker -->
    <div class="card" style="margin-top:16px">
      <div id="ticker-host"><div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div></div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="assetToolbar">
      <div class="search"><input id="searchTop" type="text" placeholder="Search (e.g., SOLUSDT, VT, EURCHF)"/></div>
      <div class="tabs-wrap">
        <div id="assetTabs" class="tabs"></div>
        <div id="groupTabs" class="tabs tabs-sub"></div>
      </div>
      <button id="newListBtn" class="btn" style="display:none;">+ New list</button>
    </div>

    <div id="gridLayout" class="layout">
      <!-- List (left) -->
      <section class="list">
        <div class="list-header">
          <div class="controls"><strong id="listTitle">Symbols</strong><span class="muted" id="countPill" style="margin-left:8px;">0</span></div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="listToggle" class="icon-btn" title="Hide list">â˜°</button>
          </div>
        </div>
        <div id="symbolList"></div>
      </section>

      <!-- Chart (right) -->
      <section class="card">
        <div class="controls" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div class="controls">
            <strong>Interval:</strong>
            <button class="btn" data-int="D">1D</button>
            <button class="btn" data-int="W">1W</button>
            <button class="btn" data-int="60">1H</button>
          </div>
          <div class="controls">
            <strong>Range:</strong>
            <button class="btn" data-range="1D">1D</button>
            <button class="btn" data-range="1M">1M</button>
            <button class="btn" data-range="3M">3M</button>
            <button class="btn" data-range="YTD">YTD</button>
            <button class="btn" data-range="12M">1Y</button>
            <button class="btn" data-range="60M">5Y</button>
            <button class="btn" data-range="120M">10Y</button>
            <button class="btn" data-range="ALL">ALL</button>
          </div>
        </div>
        <div id="adv-host" style="height:620px;"></div>
        <p class="muted">Click a symbol to load the chart. Use â˜… favorites, ï¼‹ add to list, ðŸ”” set alert.</p>
      </section>
    </div>

    <!-- Right-edge toggle -->
    <button id="listRightToggle" class="floating-btn" title="Hide list">â˜°</button>
  </main>

  <!-- Settings Modal -->
  <div id="backdrop" style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none;"></div>
  <div id="settingsModal" class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:520px; max-width:90vw; display:none;">
    <h3>Settings</h3>
    <label style="display:block; font-weight:700; margin-top:10px;" for="alphaKey">Alpha Vantage API key (optional)</label>
    <input id="alphaKey" type="text" placeholder="Enter your API key" style="width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text);"/>
    <label style="display:block; font-weight:700; margin-top:10px;" for="pollSec">Polling interval (seconds)</label>
    <input id="pollSec" type="number" min="10" value="30" style="width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text);"/>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button id="settingsCancel" class="btn">Cancel</button>
      <button id="settingsSave" class="btn">Save</button>
    </div>
    <p class="muted">Crypto alerts work out-of-the-box via Binance. Stocks/ETFs/FX require an Alpha Vantage key.</p>
  </div>

  <footer style="text-align:center; color:#66758f; padding:16px; border-top:1px solid var(--border); margin-top:24px;">GPT - Great Portfolio Tracer</footer>

<script>
  // ====== Config data ======
  const TICKER_CFG = { light: {
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "BINANCE:SOLUSDT",
      "title": "SOLUSDT"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "light",
  "locale": "en"
}, dark: {
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "BINANCE:SOLUSDT",
      "title": "SOLUSDT"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "dark",
  "locale": "en"
} };
  const CATALOG_BASE = {"favorites": {"label": "Favorites", "groups": {"my_favs": {"label": "My Favorites", "symbols": []}}}, "mylists": {"label": "My Lists", "groups": {}}, "equities": {"label": "Stocks", "groups": {"us_top": {"label": "US Top", "symbols": [{"s": "NASDAQ:NVDA", "d": "NVDA \u2014 NVIDIA"}, {"s": "NASDAQ:MSFT", "d": "MSFT \u2014 Microsoft"}, {"s": "NASDAQ:AAPL", "d": "AAPL \u2014 Apple"}, {"s": "NASDAQ:AMZN", "d": "AMZN \u2014 Amazon"}, {"s": "NASDAQ:META", "d": "META \u2014 Meta"}, {"s": "NASDAQ:AVGO", "d": "AVGO \u2014 Broadcom"}, {"s": "NASDAQ:GOOGL", "d": "GOOGL \u2014 Alphabet A"}, {"s": "NYSE:BRK.B", "d": "BRK.B \u2014 Berkshire B"}, {"s": "NASDAQ:TSLA", "d": "TSLA \u2014 Tesla"}, {"s": "NYSE:LLY", "d": "LLY \u2014 Eli Lilly"}]}, "ch_six": {"label": "Switzerland (SIX)", "symbols": [{"s": "SIX:NESN", "d": "NESN \u2014 Nestl\u00e9"}, {"s": "SIX:ROG", "d": "ROG \u2014 Roche Holding"}, {"s": "SIX:NOVN", "d": "NOVN \u2014 Novartis"}, {"s": "SIX:UBSG", "d": "UBSG \u2014 UBS Group"}, {"s": "SIX:ABBN", "d": "ABBN \u2014 ABB"}, {"s": "SIX:ZURN", "d": "ZURN \u2014 Zurich Insurance"}]}}}, "crypto": {"label": "Crypto", "groups": {"top_volume": {"label": "Top by Volume (Binance)", "symbols": [{"s": "BINANCE:BTCUSDT", "d": "BTCUSDT \u2014 Bitcoin"}, {"s": "BINANCE:ETHUSDT", "d": "ETHUSDT \u2014 Ethereum"}, {"s": "BINANCE:SOLUSDT", "d": "SOLUSDT \u2014 Solana"}, {"s": "BINANCE:BNBUSDT", "d": "BNBUSDT \u2014 BNB"}, {"s": "BINANCE:XRPUSDT", "d": "XRPUSDT \u2014 XRP"}, {"s": "BINANCE:DOGEUSDT", "d": "DOGEUSDT \u2014 Dogecoin"}, {"s": "BINANCE:TONUSDT", "d": "TONUSDT \u2014 Toncoin"}, {"s": "BINANCE:ADAUSDT", "d": "ADAUSDT \u2014 Cardano"}, {"s": "BINANCE:TRXUSDT", "d": "TRXUSDT \u2014 TRON"}, {"s": "BINANCE:AVAXUSDT", "d": "AVAXUSDT \u2014 Avalanche"}, {"s": "BINANCE:LINKUSDT", "d": "LINKUSDT \u2014 Chainlink"}, {"s": "BINANCE:LTCUSDT", "d": "LTCUSDT \u2014 Litecoin"}, {"s": "BINANCE:SHIBUSDT", "d": "SHIBUSDT \u2014 Shiba Inu"}, {"s": "BINANCE:NEARUSDT", "d": "NEARUSDT \u2014 NEAR"}]}}}, "etfs": {"label": "ETFs", "groups": {"core_us": {"label": "Core US", "symbols": [{"s": "AMEX:SPY", "d": "SPY \u2014 SPDR S&P 500"}, {"s": "AMEX:VOO", "d": "VOO \u2014 Vanguard S&P 500"}, {"s": "NASDAQ:QQQ", "d": "QQQ \u2014 Invesco QQQ"}, {"s": "AMEX:VTI", "d": "VTI \u2014 Vanguard Total Market"}, {"s": "AMEX:VT", "d": "VT \u2014 Vanguard Total World Stock"}]}, "ucits_eu": {"label": "UCITS (EU/UK)", "symbols": [{"s": "XETR:EUNL", "d": "EUNL \u2014 iShares Core MSCI World UCITS"}, {"s": "XETR:SXR8", "d": "SXR8 \u2014 iShares Core S&P 500 UCITS (Acc)"}, {"s": "LSE:VWRL", "d": "VWRL \u2014 Vanguard FTSE All-World UCITS"}]}}}, "fx": {"label": "FX", "groups": {"majors_chf": {"label": "Majors & CHF", "symbols": [{"s": "OANDA:EURUSD", "d": "EURUSD \u2014 Euro / US Dollar"}, {"s": "OANDA:USDCHF", "d": "USDCHF \u2014 US Dollar / Swiss Franc"}, {"s": "OANDA:EURCHF", "d": "EURCHF \u2014 Euro / Swiss Franc"}]}}}, "commodities": {"label": "Commodities", "groups": {"energy": {"label": "Energy", "symbols": [{"s": "NYMEX:CL1!", "d": "CL1! \u2014 Crude Oil WTI"}, {"s": "NYMEX:NG1!", "d": "NG1! \u2014 Natural Gas"}]}, "precious": {"label": "Precious Metals", "symbols": [{"s": "COMEX:GC1!", "d": "GC1! \u2014 Gold Futures"}, {"s": "COMEX:SI1!", "d": "SI1! \u2014 Silver Futures"}]}, "agriculture": {"label": "Agriculture", "symbols": [{"s": "CBOT:ZC1!", "d": "ZC1! \u2014 Corn (CBOT)"}, {"s": "CBOT:ZW1!", "d": "ZW1! \u2014 Wheat (CBOT)"}, {"s": "CBOT:ZS1!", "d": "ZS1! \u2014 Soybeans (CBOT)"}, {"s": "ICEUS:KC1!", "d": "KC1! \u2014 Coffee (ICE US)"}, {"s": "ICEUS:SB1!", "d": "SB1! \u2014 Sugar No.11 (ICE US)"}, {"s": "ICEUS:CC1!", "d": "CC1! \u2014 Cocoa (ICE US)"}]}, "base_metals": {"label": "Base Metals", "symbols": [{"s": "TVC:ALUMINUM", "d": "ALUMINUM \u2014 Aluminum (CFD)"}, {"s": "TVC:NICKEL", "d": "NICKEL \u2014 Nickel (CFD)"}, {"s": "TVC:ZINC", "d": "ZINC \u2014 Zinc (CFD)"}, {"s": "COMEX:HG1!", "d": "HG1! \u2014 Copper (COMEX)"}]}}}};

  function safeJSON(s) { try { return JSON.parse(s||''); } catch(e) { return null; } }

  const store = {
    theme: localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'),
    listCollapsed: localStorage.getItem('listCollapsed')==='true',
    favorites: safeJSON(localStorage.getItem('favorites')) || [],
    mylists: safeJSON(localStorage.getItem('mylists')) || {}, // {id:{label, symbols:[]}}
    lastSymbol: localStorage.getItem('lastSymbol') || null,
    interval: localStorage.getItem('interval') || 'D',
    range: localStorage.getItem('range') || '12M',
    asset: localStorage.getItem('asset') || 'crypto',
    group: localStorage.getItem('group') || 'top_volume',
    alerts: safeJSON(localStorage.getItem('alerts')) || [],
    alphaKey: localStorage.getItem('alphaKey') || '',
    pollSec: parseInt(localStorage.getItem('pollSec') || '30', 10),
  };

  function buildCatalog() {
    const C = JSON.parse(JSON.stringify(CATALOG_BASE));
    const dyn = {};
    Object.entries(store.mylists).forEach(([id,obj]) => dyn[id] = { label: obj.label, symbols: obj.symbols||[] });
    C.mylists.groups = dyn;
    return C;
  }
  let CATALOG = buildCatalog();

  // ====== Theme & header popovers ======
  document.documentElement.setAttribute('data-theme', store.theme);
  const themeBtn = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeLabel = document.getElementById('themeLabel');
  function updateTheme() { themeLabel.textContent = store.theme==='dark'?'Dark':'Light'; themeIcon.textContent = store.theme==='dark'?'ðŸŒ™':'â˜€'; }
  updateTheme();
  themeBtn.addEventListener('click', ()=>{ store.theme = store.theme==='light'?'dark':'light'; localStorage.setItem('theme', store.theme); document.documentElement.setAttribute('data-theme', store.theme); updateTheme(); renderTicker(); renderAdvanced(); });

  function togglePopover(btnId, popId){ const btn=document.getElementById(btnId), pop=document.getElementById(popId); let open=false; btn.addEventListener('click',(e)=>{ e.stopPropagation(); open=!open; pop.style.display=open?'block':'none'; if(popId==='alertsPopover') renderAlertsList(); }); document.addEventListener('click',(e)=>{ if(open && !pop.contains(e.target) && e.target!==btn){ open=false; pop.style.display='none'; } }); }
  togglePopover('helpBtn','helpPopover'); togglePopover('alertsBtn','alertsPopover');

  // ====== Ticker ======
  function renderTicker() {
    const host = document.getElementById('ticker-host');
    host.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
    script.async = true;
    script.innerHTML = JSON.stringify(TICKER_CFG[store.theme], null, 2);
    host.querySelector('.tradingview-widget-container').appendChild(script);
  }
  renderTicker();

  // ====== Tabs (assets + groups) ======
  const assetTabs = document.getElementById('assetTabs');
  const groupTabs = document.getElementById('groupTabs');
  const newListBtn = document.getElementById('newListBtn');
  const searchTop  = document.getElementById('searchTop');

  function renderAssetTabs(){
    const order = ['favorites','mylists','equities','crypto','etfs','fx','commodities'];
    assetTabs.innerHTML='';
    order.forEach(id=>{
      if(!CATALOG[id]) return;
      const tab=document.createElement('div'); tab.className='tab'+(store.asset===id?' active':'');
      tab.textContent = CATALOG[id].label;
      tab.addEventListener('click',()=>{
        store.asset=id; localStorage.setItem('asset', id);
        const firstGroupKey = Object.keys(CATALOG[id].groups)[0] || null;
        store.group = firstGroupKey; localStorage.setItem('group', store.group||'');
        renderAssetTabs(); renderGroupTabs(); renderList();
        newListBtn.style.display = (id==='mylists')?'inline-block':'none';
      });
      assetTabs.appendChild(tab);
    });
    newListBtn.style.display = (store.asset==='mylists')?'inline-block':'none';
  }

  function renderGroupTabs(){
    groupTabs.innerHTML='';
    const groups = (CATALOG[store.asset] && CATALOG[store.asset].groups) || {};
    const keys = Object.keys(groups);
    if(keys.length===0){
      const empty=document.createElement('div'); empty.className='muted'; empty.textContent='No groups'; groupTabs.appendChild(empty);
      return;
    }
    keys.forEach(gid=>{
      const tab=document.createElement('div'); tab.className='tab'+(store.group===gid?' active':'');
      tab.textContent=groups[gid].label;
      tab.addEventListener('click',()=>{
        store.group=gid; localStorage.setItem('group', gid);
        renderGroupTabs(); renderList();
      });
      groupTabs.appendChild(tab);
    });
  }

  newListBtn.addEventListener('click', ()=>{
    const name = prompt('New list name:'); if(!name) return;
    const id = Math.random().toString(36).slice(2,9);
    store.mylists[id] = { label: name, symbols: [] };
    localStorage.setItem('mylists', JSON.stringify(store.mylists));
    CATALOG = buildCatalog();
    store.asset='mylists'; store.group=id; localStorage.setItem('asset','mylists'); localStorage.setItem('group', id);
    renderAssetTabs(); renderGroupTabs(); renderList();
  });

  renderAssetTabs(); renderGroupTabs();

  // ====== Layout (list collapse) ======
  const gridLayout = document.getElementById('gridLayout');
  const listRightToggle = document.getElementById('listRightToggle');
  const listToggle = document.getElementById('listToggle');
  function applyLayout(){
    gridLayout.classList.toggle('list-collapsed', store.listCollapsed);
    listRightToggle.title = store.listCollapsed ? 'Show list' : 'Hide list';
  }
  applyLayout();
  function toggleList(){ store.listCollapsed=!store.listCollapsed; localStorage.setItem('listCollapsed', store.listCollapsed); applyLayout(); setTimeout(renderAdvanced,60); }
  listRightToggle.addEventListener('click', toggleList);
  listToggle.addEventListener('click', toggleList);

  // ====== List + search ======
  const listTitle=document.getElementById('listTitle'); const countPill=document.getElementById('countPill'); const listHost=document.getElementById('symbolList');
  function getAllSymbols(){
    const arr=[];
    Object.values(CATALOG).forEach(asset=>{
      Object.values(asset.groups).forEach(g=> g.symbols.forEach(x=>arr.push({s:x.s,d:x.d})));
    });
    const seen=new Set(); const uniq=[];
    arr.forEach(x=>{ if(!seen.has(x.s)){ seen.add(x.s); uniq.push(x); } });
    return uniq;
  }
  let ALL_SYMBOLS = getAllSymbols();

  function getGroupSymbols(){ if(store.asset==='favorites') return store.favorites; if(store.asset==='mylists') return (store.mylists[store.group]?.symbols)||[]; return (CATALOG[store.asset]?.groups[store.group]?.symbols)||[]; }
  function getGlobalResults(q){ const qq=q.toLowerCase(); return ALL_SYMBOLS.filter(x=>x.s.toLowerCase().includes(qq)||(x.d||'').toLowerCase().includes(qq)); }
  function isFav(sym){ return store.favorites.some(x=>x.s===sym); }
  function saveFavs(){ localStorage.setItem('favorites', JSON.stringify(store.favorites)); }

  function addToMyList(obj){
    const keys=Object.keys(store.mylists); let target=keys[0];
    if(keys.length===0){ const name=prompt('Create a new list name:'); if(!name) return; const id=Math.random().toString(36).slice(2,9); store.mylists[id]={label:name, symbols:[]}; target=id; }
    else { const names=keys.map(k=>store.mylists[k].label); const choice=prompt('Add to which list?\n'+names.map((n,i)=>(i+1)+'. '+n).join('\n'),'1'); if(!choice) return; const idx=parseInt(choice,10)-1; if(isNaN(idx)||idx<0||idx>=keys.length) return; target=keys[idx]; }
    const arr=store.mylists[target].symbols; if(!arr.some(x=>x.s===obj.s)) arr.push(obj);
    localStorage.setItem('mylists', JSON.stringify(store.mylists));
    CATALOG = buildCatalog(); ALL_SYMBOLS = getAllSymbols();
    if(store.asset==='mylists' && store.group===target) renderList();
  }

  function renderList(){
    const q=(searchTop.value||'').trim(); let symbols, title;
    if(q){ symbols=getGlobalResults(q); title='Search results'; }
    else if(store.asset==='favorites'){ symbols=getGroupSymbols(); title='My Favorites'; }
    else if(store.asset==='mylists'){ symbols=getGroupSymbols(); title=store.mylists[store.group]?.label || 'My Lists'; }
    else { const meta=(CATALOG[store.asset] && CATALOG[store.asset].groups[store.group]) || {label:'Symbols', symbols:[]}; symbols=meta.symbols; title=meta.label; }
    listTitle.textContent=title; countPill.textContent=symbols.length+' items'; listHost.innerHTML='';
    symbols.forEach(obj=>{
      const row=document.createElement('div'); row.className='row';
      const left=document.createElement('div'); left.className='left';
      const sym=document.createElement('div'); sym.className='symbol'; sym.textContent=obj.s;
      const desc=document.createElement('div'); desc.className='muted'; desc.textContent=obj.d||'';
      left.appendChild(sym); left.appendChild(desc);
      const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
      const plus=document.createElement('span'); plus.className='plus'; plus.textContent='ï¼‹'; plus.title='Add to My Lists'; plus.addEventListener('click',(e)=>{ e.stopPropagation(); addToMyList(obj); });
      const bell=document.createElement('span'); bell.className='bell'; bell.textContent='ðŸ””'; bell.title='Set alert'; bell.addEventListener('click',(e)=>{ e.stopPropagation(); createAlertFlow(obj); });
      const star=document.createElement('span'); star.className='star'+(isFav(obj.s)?' fav':''); star.textContent=isFav(obj.s)?'â˜…':'â˜†'; star.title=isFav(obj.s)?'Remove favorite':'Add favorite';
      star.addEventListener('click',(e)=>{ e.stopPropagation(); if(isFav(obj.s)) store.favorites=store.favorites.filter(x=>x.s!==obj.s); else store.favorites.push(obj); saveFavs(); star.classList.toggle('fav'); star.textContent=star.classList.contains('fav')?'â˜…':'â˜†'; });
      const arrow=document.createElement('div'); arrow.className='muted'; arrow.style.marginLeft='8px'; arrow.textContent='âžœ';
      right.appendChild(plus); right.appendChild(bell); right.appendChild(star); right.appendChild(arrow);
      row.appendChild(left); row.appendChild(right);
      row.addEventListener('click',()=>{ store.lastSymbol=obj.s; localStorage.setItem('lastSymbol', store.lastSymbol); renderAdvanced(); });
      listHost.appendChild(row);
    });
  }
  searchTop.addEventListener('input', ()=>renderList());
  renderList();

  // ====== Advanced chart ======
  const advHost = document.getElementById('adv-host');
  const intButtons = Array.from(document.querySelectorAll('.btn[data-int]'));
  const rangeButtons = Array.from(document.querySelectorAll('.btn[data-range]'));
  function syncBtns(){ intButtons.forEach(b=>b.classList.toggle('active', b.dataset.int===store.interval)); rangeButtons.forEach(b=>b.classList.toggle('active', b.dataset.range===store.range)); }
  function renderAdvanced(){
    syncBtns();
    advHost.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
    script.async = true;
    const cfg = {
      autosize: true, symbol: store.lastSymbol || 'BINANCE:BTCUSDT',
      interval: store.interval, range: store.range, timezone: 'Etc/UTC',
      theme: store.theme, style: '1', locale: 'en',
      allow_symbol_change: false, withdateranges: true,
      hide_side_toolbar: false, hide_top_toolbar: false, save_image: false,
      studies: [], calendar: false, support_host: 'https://www.tradingview.com'
    };
    script.innerHTML = JSON.stringify(cfg, null, 2);
    advHost.querySelector('.tradingview-widget-container').appendChild(script);
  }
  intButtons.forEach(btn=>btn.addEventListener('click',()=>{ store.interval=btn.dataset.int; localStorage.setItem('interval', store.interval); renderAdvanced(); }));
  rangeButtons.forEach(btn=>btn.addEventListener('click',()=>{ store.range=btn.dataset.range; localStorage.setItem('range', store.range); renderAdvanced(); }));
  renderAdvanced();

  // ====== Settings modal ======
  const settingsBtn=document.getElementById('settingsBtn'); const backdrop=document.getElementById('backdrop'); const settingsModal=document.getElementById('settingsModal');
  const alphaKeyInput=document.getElementById('alphaKey'); const pollSecInput=document.getElementById('pollSec'); const settingsSave=document.getElementById('settingsSave'); const settingsCancel=document.getElementById('settingsCancel');
  function openModal(){ alphaKeyInput.value=store.alphaKey; pollSecInput.value=store.pollSec; backdrop.style.display='block'; settingsModal.style.display='block'; }
  function closeModal(){ backdrop.style.display='none'; settingsModal.style.display='none'; }
  settingsBtn.addEventListener('click', openModal); backdrop.addEventListener('click', closeModal); settingsCancel.addEventListener('click', closeModal);
  settingsSave.addEventListener('click', ()=>{ store.alphaKey=alphaKeyInput.value.trim(); store.pollSec=Math.max(10, parseInt(pollSecInput.value||'30',10)); localStorage.setItem('alphaKey', store.alphaKey); localStorage.setItem('pollSec', String(store.pollSec)); closeModal(); toast('Settings saved'); });

  // ====== Alerts ======
  const alertsBadge=document.getElementById('alertsBadge'); const alertsList=document.getElementById('alertsList'); const clearAlerts=document.getElementById('clearAlerts');
  function updateAlertsBadge(){ const n=store.alerts.length; alertsBadge.style.display=n>0?'inline-block':'none'; alertsBadge.textContent=n; }
  function persistAlerts(){ localStorage.setItem('alerts', JSON.stringify(store.alerts)); updateAlertsBadge(); }
  updateAlertsBadge();
  clearAlerts.addEventListener('click', ()=>{ if(confirm('Clear all alerts?')) { store.alerts=[]; persistAlerts(); renderAlertsList(); } });
  function renderAlertsList(){
    alertsList.innerHTML='';
    if(store.alerts.length===0){ alertsList.innerHTML='<div class="muted">No active alerts</div>'; return; }
    store.alerts.forEach((a,idx)=>{
      const line=document.createElement('div'); line.className='row'; line.style.padding='6px 0'; line.style.cursor='default';
      const left=document.createElement('div'); left.textContent = a.s + ' ' + (a.dir==='above'?'â‰¥':'â‰¤') + ' ' + a.target + (a.source==='binance'?' (Binance)':(a.source==='alpha'?' (Alpha)':' (N/A)'));
      const rm=document.createElement('span'); rm.className='muted'; rm.style.cursor='pointer'; rm.textContent='remove';
      rm.addEventListener('click',()=>{ store.alerts.splice(idx,1); persistAlerts(); renderAlertsList(); });
      line.appendChild(left); line.appendChild(rm); alertsList.appendChild(line);
    });
  }

  function mapSymbol(sym){
    const p=sym.split(':'), ex=p[0], code=p.slice(1).join(':');
    if(ex==='BINANCE') return { source:'binance', url:'https://api.binance.com/api/v3/ticker/price?symbol='+code, parse:(j)=>parseFloat(j.price) };
    if(ex==='OANDA' && code.length===6 && store.alphaKey){
      const from=code.slice(0,3), to=code.slice(3);
      return { source:'alpha', url:'https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency='+from+'&to_currency='+to+'&apikey='+store.alphaKey, parse:(j)=>parseFloat(j['Realtime Currency Exchange Rate']&&j['Realtime Currency Exchange Rate']['5. Exchange Rate']) };
    }
    let ticker=code; if(ex==='SIX') ticker=code+'.SW';
    if(store.alphaKey) return { source:'alpha', url:'https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol='+encodeURIComponent(ticker)+'&apikey='+store.alphaKey, parse:(j)=>parseFloat(j['Global Quote']&&j['Global Quote']['05. price']) };
    return { source:null };
  }

  function createAlertFlow(obj){
    const when = prompt('Alert when price is (above | below):','above'); if(!when) return;
    const t = parseFloat(prompt('Target price:','')); if(!isFinite(t)) return;
    const map = mapSymbol(obj.s); if(!map.source) alert('This symbol may not be supported for live polling unless you add an API key in Settings.');
    const a={ id:Math.random().toString(36).slice(2,9), s:obj.s, d:obj.d||'', target:t, dir:(when.toLowerCase()==='below'?'below':'above'), source:map.source, map:map, createdAt:Date.now() };
    store.alerts.push(a); persistAlerts(); renderAlertsList(); requestNotify(); toast('Alert added for '+obj.s);
  }

  function requestNotify(){ if('Notification' in window && Notification.permission==='default') Notification.requestPermission(); }
  function notify(title, body){ if('Notification' in window && Notification.permission==='granted') new Notification(title,{ body }); else toast(title+': '+body); }

  async function pollAlerts(){
    if(store.alerts.length===0) return;
    for(const a of [...store.alerts]){
      try{
        if(a.source==='binance'){
          const r=await fetch(a.map.url); if(!r.ok) continue; const j=await r.json(); const price=a.map.parse(j); if(!isFinite(price)) continue;
          if((a.dir==='above' && price>=a.target) || (a.dir==='below' && price<=a.target)){ notify('Alert: '+a.s, 'Price hit '+a.dir+' '+a.target+' (now '+price+')'); store.alerts=store.alerts.filter(x=>x.id!==a.id); persistAlerts(); renderAlertsList(); }
        } else if(a.source==='alpha' && store.alphaKey){
          const r=await fetch(a.map.url); if(!r.ok) continue; const j=await r.json(); const price=a.map.parse(j); if(!isFinite(price)) continue;
          if((a.dir==='above' && price>=a.target) || (a.dir==='below' && price<=a.target)){ notify('Alert: '+a.s, 'Price hit '+a.dir+' '+a.target+' (now '+price+')'); store.alerts=store.alerts.filter(x=>x.id!==a.id); persistAlerts(); renderAlertsList(); }
        }
      }catch(e){}
    }
  }
  setInterval(pollAlerts, Math.max(10, store.pollSec)*1000);

  // ====== Toast helper ======
  function toast(msg){ const t=document.createElement('div'); t.style.position='fixed'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.bottom='18px'; t.style.background='#111827'; t.style.color:'#f9fafb'; t.style.padding='10px 14px'; t.style.borderRadius='999px'; t.style.boxShadow='0 6px 24px rgba(0,0,0,.18)'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity 300ms'; },1600); setTimeout(()=>{ t.remove(); },2000); }
</script>
<script>
  // Advanced chart loader (ensures DOM is ready)
  (function(){
    const intButtons = Array.from(document.querySelectorAll('.btn[data-int]'));
    const rangeButtons = Array.from(document.querySelectorAll('.btn[data-range]'));
    function syncBtns(){ const interval=localStorage.getItem('interval')||'D'; const range=localStorage.getItem('range')||'12M'; intButtons.forEach(b=>b.classList.toggle('active', b.dataset.int===interval)); rangeButtons.forEach(b=>b.classList.toggle('active', b.dataset.range===range)); }
    window.renderAdvanced = function(){
      syncBtns();
      const advHost = document.getElementById('adv-host');
      advHost.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
      const s = document.createElement('script');
      s.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
      s.async = true;
      const cfg = {
        autosize:true, symbol: localStorage.getItem('lastSymbol') || 'BINANCE:BTCUSDT',
        interval: localStorage.getItem('interval') || 'D',
        range: localStorage.getItem('range') || '12M',
        timezone:'Etc/UTC', theme: localStorage.getItem('theme') || 'light', style:'1', locale:'en',
        allow_symbol_change:false, withdateranges:true, hide_side_toolbar:false, hide_top_toolbar:false, save_image:false, studies:[], calendar:false,
        support_host:'https://www.tradingview.com'
      };
      s.innerHTML = JSON.stringify(cfg, null, 2);
      advHost.querySelector('.tradingview-widget-container').appendChild(s);
    };
    intButtons.forEach(btn=>btn.addEventListener('click',()=>{ localStorage.setItem('interval', btn.dataset.int); window.renderAdvanced(); }));
    rangeButtons.forEach(btn=>btn.addEventListener('click',()=>{ localStorage.setItem('range', btn.dataset.range); window.renderAdvanced(); }));
    window.renderAdvanced();
  })();
</script>
<script>
  // Ensure ticker renders with correct theme initially
  (function(){
    const host=document.getElementById('ticker-host');
    const theme=(localStorage.getItem('theme')||'light');
    const cfg=theme==='dark'?{
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "BINANCE:SOLUSDT",
      "title": "SOLUSDT"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "dark",
  "locale": "en"
}:{
  "symbols": [
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "BINANCE:SOLUSDT",
      "title": "SOLUSDT"
    },
    {
      "proName": "AMEX:VT",
      "title": "VT"
    },
    {
      "proName": "SIX:NESN",
      "title": "NESN"
    },
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "OANDA:EURCHF",
      "title": "EURCHF"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "light",
  "locale": "en"
};
    host.innerHTML='<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
    const s=document.createElement('script'); s.src='https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js'; s.async=true; s.innerHTML=JSON.stringify(cfg, null, 2); host.querySelector('.tradingview-widget-container').appendChild(s);
  })();
</script>
</body>
</html>
