<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GPT - Great Portfolio Tracer</title>
  <meta name="description" content="Great Portfolio Tracer — browse Stocks, Crypto, ETFs, Indices, FX & Commodities with favorites, global search, and an advanced chart."/>
  <meta name="theme-color" content="#0f62fe"/>
  <link rel="icon" type="image/svg+xml" href="logo.svg"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png"/>
  <style>
    :root {
      --brand:#0f62fe;
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0b1221;
      --muted:#66758f;
      --border:#e5e8ef;
      --sidebar:#eef2ff;
    }
    [data-theme="dark"] {
      --bg:#0b0f17;
      --card:#111827;
      --text:#f5f7fb;
      --muted:#b6c0d1;
      --border:#24324a;
      --sidebar:#0f172a;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:var(--bg); color:var(--text);}
    header { padding: 10px 16px; background: var(--brand); color: white; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand img { height:26px; width:auto; display:block; }
    .toggle-btn { display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.3); color:#fff;
                   padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:600; }
    .toggle-btn svg { width:18px; height:18px; }
    main { max-width: 1500px; margin: 0 auto; padding: 16px; }
    .section { margin-top: 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
    .global-search { display:flex; gap:8px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px; }
    .global-search input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text); }
    .layout { display:grid; grid-template-columns: 260px 350px 1fr; gap:16px; align-items:start; }
    .sidebar { background:var(--sidebar); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .sidebar h3 { margin:4px 0 10px; font-size:14px; opacity:.9; }
    .nav-group { margin-bottom:12px; }
    .nav-title { font-weight:800; margin:8px 0 6px; font-size:13px; text-transform:uppercase; opacity:.8; }
    .nav-item { display:block; width:100%; text-align:left; border:1px solid var(--border); background:var(--card); color:var(--text);
                 padding:8px 10px; border-radius:8px; cursor:pointer; margin-bottom:6px; font-weight:600; }
    .nav-item.active { background: var(--brand); border-color: var(--brand); color:white; }
    .list { border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .list-header { display:flex; align-items:center; gap:8px; padding:10px; border-bottom:1px solid var(--border); justify-content:space-between; }
    .search input { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text); }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid var(--border); cursor:pointer; }
    .row:hover { background: rgba(15, 98, 254, .08); }
    .left { display:flex; flex-direction:column; }
    .symbol { font-weight:700; }
    .muted { color:var(--muted); font-size:12px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid var(--border); background:var(--card); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; color:var(--text); }
    .btn.active { background: var(--brand); border-color: var(--brand); color:white; }
    .star { width:18px; height:18px; display:inline-block; margin-left:8px; }
    .star svg { width:18px; height:18px; fill: none; stroke: currentColor; stroke-width: 2; }
    .star.active svg { fill: currentColor; }
    footer { text-align:center; color:var(--muted); padding: 16px; border-top:1px solid var(--border); margin-top:24px; }
    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logo.svg" alt="GPT logo" />
      <strong>GPT - Great Portfolio Tracer</strong>
    </div>
    <button id="themeToggle" class="toggle-btn" title="Toggle light/dark">
      <span id="themeIcon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zm10.48 14.32l1.79 1.79 1.79-1.79-1.79-1.79-1.79 1.79zM12 4V1h-0v3h0zm0 19v-3h-0v3h0zm8-11h3v0h-3v0zm-19 0v0h3v0H1zM6.76 19.16l-1.8 1.79-1.79-1.79 1.79-1.79 1.8 1.79zM17.24 4.84l1.79-1.79 1.79 1.79-1.79 1.79-1.79-1.79zM12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
      </span>
      <span id="themeLabel">Light</span>
    </button>
  </header>

  <main>
    <!-- Top ticker -->
    <div class="section card">
      <div id="ticker-host">
        <div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>
      </div>
    </div>

    <!-- Global search -->
    <div class="section global-search">
      <strong>Global Search:</strong>
      <input id="globalSearch" type="text" placeholder="Search across all assets (e.g., SPY, EURUSD, Bitcoin, NVIDIA)"/>
      <span class="muted" id="globalCount"></span>
    </div>

    <!-- Three-column layout -->
    <div class="section layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h3>Asset classes</h3>
        <div id="sidebar"></div>
      </aside>

      <!-- Symbol list (current group) -->
      <section class="list">
        <div class="list-header">
          <div class="controls">
            <strong id="listTitle">Symbols</strong>
            <span class="pill" id="countPill">0</span>
          </div>
          <div class="search"><input id="search" type="text" placeholder="Filter in this list"/></div>
        </div>
        <div id="symbolList"></div>
      </section>

      <!-- Advanced chart -->
      <section class="card">
        <div class="controls" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div class="controls">
            <strong>Interval:</strong>
            <button class="btn" data-int="D">1D</button>
            <button class="btn" data-int="W">1W</button>
            <button class="btn" data-int="60">1H</button>
          </div>
          <div class="controls">
            <strong>Range:</strong>
            <button class="btn" data-range="1D">1D</button>
            <button class="btn" data-range="1M">1M</button>
            <button class="btn" data-range="3M">3M</button>
            <button class="btn" data-range="YTD">YTD</button>
            <button class="btn" data-range="12M">1Y</button>
            <button class="btn" data-range="60M">5Y</button>
            <button class="btn" data-range="120M">10Y</button>
            <button class="btn" data-range="ALL">ALL</button>
          </div>
        </div>
        <div id="adv-host" style="height:620px;"></div>
        <p class="muted">Click a symbol in the middle list or a global search result to load it on the chart. Use the ★ to add/remove favorites.</p>
      </section>
    </div>
  </main>

  <footer>GPT - Great Portfolio Tracer</footer>

  <script>
    // ====== Data ======
    const TICKER_CFG = {
      light: {
  "symbols": [
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "NASDAQ:MSFT",
      "title": "MSFT"
    },
    {
      "proName": "NASDAQ:AAPL",
      "title": "AAPL"
    },
    {
      "proName": "NASDAQ:AMZN",
      "title": "AMZN"
    },
    {
      "proName": "NASDAQ:META",
      "title": "META"
    },
    {
      "proName": "NASDAQ:AVGO",
      "title": "AVGO"
    },
    {
      "proName": "NASDAQ:GOOGL",
      "title": "GOOGL"
    },
    {
      "proName": "NASDAQ:GOOG",
      "title": "GOOG"
    },
    {
      "proName": "NYSE:BRK.B",
      "title": "BRK.B"
    },
    {
      "proName": "NASDAQ:TSLA",
      "title": "TSLA"
    },
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "BINANCE:BNBUSDT",
      "title": "BNBUSDT"
    },
    {
      "proName": "BINANCE:SOLUSDT",
      "title": "SOLUSDT"
    },
    {
      "proName": "KRAKEN:USDTUSD",
      "title": "USDTUSD"
    },
    {
      "proName": "AMEX:SPY",
      "title": "SPY"
    },
    {
      "proName": "NASDAQ:QQQ",
      "title": "QQQ"
    },
    {
      "proName": "FX:EURUSD",
      "title": "EURUSD"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "light",
  "locale": "en"
},
      dark: {
  "symbols": [
    {
      "proName": "NASDAQ:NVDA",
      "title": "NVDA"
    },
    {
      "proName": "NASDAQ:MSFT",
      "title": "MSFT"
    },
    {
      "proName": "NASDAQ:AAPL",
      "title": "AAPL"
    },
    {
      "proName": "NASDAQ:AMZN",
      "title": "AMZN"
    },
    {
      "proName": "NASDAQ:META",
      "title": "META"
    },
    {
      "proName": "NASDAQ:AVGO",
      "title": "AVGO"
    },
    {
      "proName": "NASDAQ:GOOGL",
      "title": "GOOGL"
    },
    {
      "proName": "NASDAQ:GOOG",
      "title": "GOOG"
    },
    {
      "proName": "NYSE:BRK.B",
      "title": "BRK.B"
    },
    {
      "proName": "NASDAQ:TSLA",
      "title": "TSLA"
    },
    {
      "proName": "BINANCE:BTCUSDT",
      "title": "BTCUSDT"
    },
    {
      "proName": "BINANCE:ETHUSDT",
      "title": "ETHUSDT"
    },
    {
      "proName": "BINANCE:BNBUSDT",
      "title": "BNBUSDT"
    },
    {
      "proName": "BINANCE:SOLUSDT",
      "title": "SOLUSDT"
    },
    {
      "proName": "KRAKEN:USDTUSD",
      "title": "USDTUSD"
    },
    {
      "proName": "AMEX:SPY",
      "title": "SPY"
    },
    {
      "proName": "NASDAQ:QQQ",
      "title": "QQQ"
    },
    {
      "proName": "FX:EURUSD",
      "title": "EURUSD"
    }
  ],
  "showSymbolLogo": true,
  "isTransparent": false,
  "displayMode": "adaptive",
  "colorTheme": "dark",
  "locale": "en"
}
    };
    const CATALOG = {"favorites": {"label": "\u2605 Favorites", "groups": {"saved": {"label": "Saved", "symbols": []}}}, "equities": {"label": "Stocks", "groups": {"sp_top20": {"label": "S&P Top 20", "symbols": [{"s": "NASDAQ:NVDA", "d": "NVDA \u2014 NVIDIA"}, {"s": "NASDAQ:MSFT", "d": "MSFT \u2014 Microsoft"}, {"s": "NASDAQ:AAPL", "d": "AAPL \u2014 Apple"}, {"s": "NASDAQ:AMZN", "d": "AMZN \u2014 Amazon"}, {"s": "NASDAQ:META", "d": "META \u2014 Meta"}, {"s": "NASDAQ:AVGO", "d": "AVGO \u2014 Broadcom"}, {"s": "NASDAQ:GOOGL", "d": "GOOGL \u2014 Alphabet A"}, {"s": "NASDAQ:GOOG", "d": "GOOG \u2014 Alphabet C"}, {"s": "NYSE:BRK.B", "d": "BRK.B \u2014 Berkshire B"}, {"s": "NASDAQ:TSLA", "d": "TSLA \u2014 Tesla"}, {"s": "NYSE:JPM", "d": "JPM \u2014 JPMorgan"}, {"s": "NYSE:WMT", "d": "WMT \u2014 Walmart"}, {"s": "NYSE:LLY", "d": "LLY \u2014 Eli Lilly"}, {"s": "NYSE:V", "d": "V \u2014 Visa"}, {"s": "NYSE:ORCL", "d": "ORCL \u2014 Oracle"}, {"s": "NYSE:MA", "d": "MA \u2014 Mastercard"}, {"s": "NASDAQ:NFLX", "d": "NFLX \u2014 Netflix"}, {"s": "NYSE:XOM", "d": "XOM \u2014 ExxonMobil"}, {"s": "NASDAQ:COST", "d": "COST \u2014 Costco"}, {"s": "NYSE:JNJ", "d": "JNJ \u2014 Johnson & Johnson"}]}, "mega_caps": {"label": "US Mega Caps", "symbols": [{"s": "NASDAQ:NVDA", "d": "NVDA \u2014 NVIDIA"}, {"s": "NASDAQ:MSFT", "d": "MSFT \u2014 Microsoft"}, {"s": "NASDAQ:AAPL", "d": "AAPL \u2014 Apple"}, {"s": "NASDAQ:AMZN", "d": "AMZN \u2014 Amazon"}, {"s": "NASDAQ:META", "d": "META \u2014 Meta"}, {"s": "NASDAQ:AVGO", "d": "AVGO \u2014 Broadcom"}, {"s": "NASDAQ:GOOGL", "d": "GOOGL \u2014 Alphabet A"}, {"s": "NASDAQ:GOOG", "d": "GOOG \u2014 Alphabet C"}, {"s": "NYSE:BRK.B", "d": "BRK.B \u2014 Berkshire B"}, {"s": "NASDAQ:TSLA", "d": "TSLA \u2014 Tesla"}]}, "sector_tech": {"label": "S&P \u2014 Technology", "symbols": [{"s": "NASDAQ:NVDA", "d": "NVDA \u2014 NVIDIA"}, {"s": "NASDAQ:MSFT", "d": "MSFT \u2014 Microsoft"}, {"s": "NASDAQ:AAPL", "d": "AAPL \u2014 Apple"}, {"s": "NASDAQ:META", "d": "META \u2014 Meta"}, {"s": "NASDAQ:AVGO", "d": "AVGO \u2014 Broadcom"}, {"s": "NASDAQ:GOOGL", "d": "GOOGL \u2014 Alphabet A"}, {"s": "NASDAQ:GOOG", "d": "GOOG \u2014 Alphabet C"}, {"s": "NYSE:ORCL", "d": "ORCL \u2014 Oracle"}, {"s": "NASDAQ:NFLX", "d": "NFLX \u2014 Netflix"}]}, "sector_health": {"label": "S&P \u2014 Healthcare", "symbols": [{"s": "NYSE:LLY", "d": "LLY \u2014 Eli Lilly"}, {"s": "NYSE:JNJ", "d": "JNJ \u2014 Johnson & Johnson"}]}, "sector_fin": {"label": "S&P \u2014 Financials", "symbols": [{"s": "NYSE:JPM", "d": "JPM \u2014 JPMorgan"}, {"s": "NYSE:V", "d": "V \u2014 Visa"}, {"s": "NYSE:MA", "d": "MA \u2014 Mastercard"}, {"s": "NYSE:BRK.B", "d": "BRK.B \u2014 Berkshire B"}]}, "sector_cons": {"label": "S&P \u2014 Consumer", "symbols": [{"s": "NASDAQ:AMZN", "d": "AMZN \u2014 Amazon"}, {"s": "NASDAQ:TSLA", "d": "TSLA \u2014 Tesla"}, {"s": "NASDAQ:COST", "d": "COST \u2014 Costco"}, {"s": "NYSE:WMT", "d": "WMT \u2014 Walmart"}]}, "sector_energy": {"label": "S&P \u2014 Energy", "symbols": [{"s": "NYSE:XOM", "d": "XOM \u2014 ExxonMobil"}]}}}, "crypto": {"label": "Crypto", "groups": {"top_volume": {"label": "Top by Volume", "symbols": [{"s": "BINANCE:BTCUSDT", "d": "BTCUSDT \u2014 Bitcoin"}, {"s": "BINANCE:ETHUSDT", "d": "ETHUSDT \u2014 Ethereum"}, {"s": "BINANCE:BNBUSDT", "d": "BNBUSDT \u2014 BNB"}, {"s": "BINANCE:SOLUSDT", "d": "SOLUSDT \u2014 Solana"}, {"s": "KRAKEN:USDTUSD", "d": "USDTUSD \u2014 Tether (USD)"}]}}}, "etf": {"label": "ETFs", "groups": {"majors": {"label": "Major ETFs", "symbols": [{"s": "AMEX:SPY", "d": "SPY \u2014 SPDR S&P 500"}, {"s": "NASDAQ:QQQ", "d": "QQQ \u2014 Invesco QQQ"}, {"s": "AMEX:VOO", "d": "VOO \u2014 Vanguard S&P 500"}, {"s": "AMEX:IWM", "d": "IWM \u2014 iShares Russell 2000"}]}}}, "indices": {"label": "Indices", "groups": {"majors": {"label": "Major Indices", "symbols": [{"s": "TVC:SPX", "d": "SPX \u2014 S&P 500 Index"}, {"s": "TVC:NDX", "d": "NDX \u2014 NASDAQ 100"}, {"s": "TVC:DJI", "d": "DJI \u2014 Dow Jones"}]}}}, "fx": {"label": "FX", "groups": {"majors": {"label": "Major FX", "symbols": [{"s": "FX:EURUSD", "d": "EURUSD \u2014 Euro / US Dollar"}, {"s": "FX:USDCHF", "d": "USDCHF \u2014 US Dollar / Swiss Franc"}, {"s": "FX:GBPUSD", "d": "GBPUSD \u2014 British Pound / US Dollar"}, {"s": "FX:USDJPY", "d": "USDJPY \u2014 US Dollar / Japanese Yen"}]}}}, "commodities": {"label": "Commodities", "groups": {"benchmarks": {"label": "Benchmarks", "symbols": [{"s": "TVC:GOLD", "d": "GOLD \u2014 Gold Spot"}, {"s": "TVC:USOIL", "d": "USOIL \u2014 WTI Crude Oil"}]}}}};

    // Flatten catalog for global search
    function flattenCatalog(cat) {
      const out = [];
      Object.values(cat).forEach(asset => {
        Object.values(asset.groups).forEach(group => {
          group.symbols.forEach(s => out.push({...s}));
        });
      });
      return out;
    }
    const ALL_SYMBOLS = flattenCatalog({ ...CATALOG, favorites: undefined });

    // ====== Theme ======
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeLabel = document.getElementById('themeLabel');
    let theme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
    function updateThemeIcon() {
      if (theme === 'dark') {
        themeIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>';
        themeLabel.textContent = 'Dark';
      } else {
        themeIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zm10.48 14.32l1.79 1.79 1.79-1.79-1.79-1.79-1.79 1.79zM12 4V1h-0v3h0zm0 19v-3h-0v3h0zm8-11h3v0h-3v0zm-19 0v0h3v0H1zM6.76 19.16l-1.8 1.79-1.79-1.79 1.79-1.79 1.8 1.79zM17.24 4.84l1.79-1.79 1.79 1.79-1.79 1.79-1.79-1.79zM12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>';
        themeLabel.textContent = 'Light';
      }
    }
    updateThemeIcon();
    themeBtn.addEventListener('click', () => {
      theme = (theme === 'light') ? 'dark' : 'light';
      localStorage.setItem('theme', theme);
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeIcon();
      renderTicker();
      renderAdvanced();
    });

    // ====== Ticker ======
    const tickerHost = document.getElementById('ticker-host');
    function renderTicker() {
      tickerHost.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
      script.async = true;
      script.innerHTML = JSON.stringify(TICKER_CFG[theme], null, 2);
      tickerHost.querySelector('.tradingview-widget-container').appendChild(script);
    }
    renderTicker();

    // ====== Favorites store ======
    const FAV_KEY = 'favorites';
    function loadFavs() {
      try { return new Set(JSON.parse(localStorage.getItem(FAV_KEY) || '[]')); } catch { return new Set(); }
    }
    function saveFavs(set) {
      localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(set)));
    }
    let favorites = loadFavs();

    // ====== Sidebar ======
    const sidebar = document.getElementById('sidebar');
    let currentAsset = localStorage.getItem('asset') || 'equities';
    let currentGroup = localStorage.getItem('group') || 'sp_top20';

    function getFavoritesGroup() {
      const syms = Array.from(favorites).map(s => (ALL_SYMBOLS.find(x => x.s === s) || {s, d: s}));
      return { label: 'Saved', symbols: syms };
    }

    function renderSidebar() {
      sidebar.innerHTML = '';

      // Favorites (dynamic)
      const favWrap = document.createElement('div');
      favWrap.className = 'nav-group';
      const favTitle = document.createElement('div');
      favTitle.className = 'nav-title';
      favTitle.textContent = '★ Favorites';
      favWrap.appendChild(favTitle);
      const favBtn = document.createElement('button');
      favBtn.className = 'nav-item' + ((currentAsset==='favorites') ? ' active' : '');
      favBtn.textContent = 'Saved';
      favBtn.addEventListener('click', () => {
        currentAsset = 'favorites';
        currentGroup = 'saved';
        localStorage.setItem('asset', currentAsset);
        localStorage.setItem('group', currentGroup);
        renderSidebar();
        renderList();
      });
      favWrap.appendChild(favBtn);
      sidebar.appendChild(favWrap);

      // Other asset classes
      Object.entries(CATALOG).forEach(([assetId, asset]) => {
        if (assetId === 'favorites') return;
        const group = document.createElement('div');
        group.className = 'nav-group';
        const title = document.createElement('div');
        title.className = 'nav-title';
        title.textContent = asset.label;
        group.appendChild(title);
        Object.entries(asset.groups).forEach(([groupId, g]) => {
          const btn = document.createElement('button');
          btn.className = 'nav-item' + ((assetId===currentAsset && groupId===currentGroup) ? ' active' : '');
          btn.textContent = g.label;
          btn.addEventListener('click', () => {
            currentAsset = assetId;
            currentGroup = groupId;
            localStorage.setItem('asset', currentAsset);
            localStorage.setItem('group', currentGroup);
            renderSidebar();
            renderList();
          });
          group.appendChild(btn);
        });
        sidebar.appendChild(group);
      });
    }
    renderSidebar();

    // ====== Symbol list ======
    const listTitle = document.getElementById('listTitle');
    const countPill = document.getElementById('countPill');
    const listHost = document.getElementById('symbolList');
    const searchInput = document.getElementById('search');

    function getCurrentListMeta() {
      if (currentAsset==='favorites') return getFavoritesGroup();
      return CATALOG[currentAsset].groups[currentGroup];
    }

    function filteredSymbols(symbols, q) {
      if (!q) return symbols;
      q = q.toLowerCase().trim();
      return symbols.filter(x => (x.s||'').toLowerCase().includes(q) || (x.d||'').toLowerCase().includes(q));
    }

    function renderList() {
      const meta = getCurrentListMeta();
      listTitle.textContent = meta.label;
      const q = (searchInput.value || '');
      const symbols = filteredSymbols(meta.symbols, q);
      countPill.textContent = symbols.length + ' items';
      listHost.innerHTML = '';

      symbols.forEach(obj => {
        const row = document.createElement('div');
        row.className = 'row';

        const left = document.createElement('div');
        left.className = 'left';
        const s1 = document.createElement('div');
        s1.className = 'symbol';
        s1.textContent = obj.s;
        const s2 = document.createElement('div');
        s2.className = 'muted';
        s2.textContent = obj.d || '';
        left.appendChild(s1); left.appendChild(s2);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';

        const star = document.createElement('button');
        star.className = 'star' + (favorites.has(obj.s) ? ' active' : '');
        star.title = favorites.has(obj.s) ? 'Remove from favorites' : 'Add to favorites';
        star.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>';
        star.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (favorites.has(obj.s)) favorites.delete(obj.s); else favorites.add(obj.s);
          saveFavs(favorites);
          renderSidebar();
          renderList();
        });

        right.appendChild(star);
        const arrow = document.createElement('div');
        arrow.className = 'muted';
        arrow.textContent = '➜';
        right.appendChild(arrow);

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener('click', () => {
          advSymbol = obj.s;
          localStorage.setItem('lastSymbol', advSymbol);
          renderAdvanced();
        });

        listHost.appendChild(row);
      });
    }
    searchInput.addEventListener('input', () => renderList());
    renderList();

    // ====== Global search ======
    const globalSearch = document.getElementById('globalSearch');
    const globalCount = document.getElementById('globalCount');
    let globalTimer = null;
    function doGlobalSearch() {
      const q = globalSearch.value.toLowerCase().trim();
      if (!q) {
        globalCount.textContent = '';
        return;
      }
      const results = filteredSymbols(ALL_SYMBOLS, q).slice(0, 50);
      globalCount.textContent = results.length + ' results';
      if (results.length > 0) {
        const top = results[0];
        advSymbol = top.s;
        localStorage.setItem('lastSymbol', advSymbol);
        renderAdvanced();
      }
    }
    globalSearch.addEventListener('input', () => {
      clearTimeout(globalTimer);
      globalTimer = setTimeout(doGlobalSearch, 200);
    });

    // ====== Advanced chart ======
    const advHost = document.getElementById('adv-host');
    const intButtons = Array.from(document.querySelectorAll('.btn[data-int]'));
    const rangeButtons = Array.from(document.querySelectorAll('.btn[data-range]'));
    let advSymbol = localStorage.getItem('lastSymbol') || (CATALOG.equities.groups.sp_top20.symbols[0] || {s:'NASDAQ:AAPL'}).s;
    let advInterval = localStorage.getItem('interval') || 'D';
    let advRange = localStorage.getItem('range') || '12M';

    function syncActiveButtons() {
      intButtons.forEach(b => b.classList.toggle('active', b.dataset.int === advInterval));
      rangeButtons.forEach(b => b.classList.toggle('active', b.dataset.range === advRange));
    }
    syncActiveButtons();

    function renderAdvanced() {
      syncActiveButtons();
      advHost.innerHTML = '<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div></div>';
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
      script.async = true;
      const cfg = {
        autosize: true,
        symbol: advSymbol,
        interval: advInterval,
        range: advRange,
        timezone: 'Etc/UTC',
        theme: theme,
        style: '1',
        locale: 'en',
        allow_symbol_change: false,
        withdateranges: true,
        hide_side_toolbar: false,
        hide_top_toolbar: false,
        save_image: false,
        studies: [],
        calendar: false,
        support_host: 'https://www.tradingview.com'
      };
      script.innerHTML = JSON.stringify(cfg, null, 2);
      advHost.querySelector('.tradingview-widget-container').appendChild(script);
    }
    intButtons.forEach(btn => btn.addEventListener('click', () => {
      advInterval = btn.dataset.int;
      localStorage.setItem('interval', advInterval);
      renderAdvanced();
    }));
    rangeButtons.forEach(btn => btn.addEventListener('click', () => {
      advRange = btn.dataset.range;
      localStorage.setItem('range', advRange);
      renderAdvanced();
    }));
    renderAdvanced();
  </script>
</body>
</html>
